<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
<script src="OatyStats.js" type="text/javascript"></script>
<script src="../z_Dependencies/dynamicTextBoxes.js" type="text/javascript"></script>
<script src="../z_Dependencies/xjs.js" type="text/javascript"></script>
<script src="../z_Dependencies/content-utilities.js" type="text/javascript"></script>
<link rel = "stylesheet"
   type = "text/css"
   href = "Oatylayout.css" />
</head>
<body>
<p id="loading">Loading</p>

<p id="p1" class="resizable"></p>
<p id="p1SetScore">-</p>
<p id="p1MatchScore">-</p>

<p id="p2" class="resizable"></p>
<p id="p2SetScore">-</p>
<p id="p2MatchScore">-</p>

<p id="recentSetScore">-</p>
<p id="recentSetDate">-</p>

<script type="text/javascript">

function clearContents(){
		updateContent('#p1', "");
		updateContent('#p1SetScore', "-");
		updateContent('#p1MatchScore', "-");

		updateContent('#p2', "-");
		updateContent('#p2SetScore', "-");
		updateContent('#p2MatchScore', "-");
		
		updateContent('#recentSetScore', "-");
		updateContent('#recentSetDate', "-");
}

function debug(message){
		// TODO: Put a logger here too
		// TODO: Create a debug container
		updateContent("#recentSetScore", message);
}

function loadingFn(loadingEvent){
	if (loadingEvent.getEventType() == EventType.SETS){
		updateContent('#loading', "Loading... " + loadingEvent.getMessage() + " tournaments");
	} else if (loadingEvent.getEventType() == EventType.INFO){
		updateContent('#loading', loadingEvent.getMessage());
	} else if (loadingEvent.getEventType() == EventType.DEBUG){
		debug(loadingEvent.getMessage());
	} 
}

async function run(playerOne, playerTwo){
	var tournament = "simbarumba-2"; // Must include both players in this tournament.

	try{
		updateContent('#p1', playerOne);
		updateContent('#p2', playerTwo);

		var h2h = await getHeadToHead(playerOne, playerTwo, tournament, loadingFn);
	
		if (typeof(h2h) !== "undefined"){
			let p1SetScore = h2h.getSetCount().getP1Score();
			let p1MatchScore = h2h.getMatchCount().getP1Score();
			
			let p2SetScore = h2h.getSetCount().getP2Score();
			let p2MatchScore = h2h.getMatchCount().getP2Score();

			/** Some dirty code to add Tassy tourni stats...
			 *  (Don't look at me like that future Jamo)
			 * 
			 * Begin Workaround 24/09/2018 >>
			*/
			if (playerOne == "Indefa" && playerTwo == "James3927") {
				p1SetScore+=2;
				p1MatchScore+=8;
				p2SetScore+=1;
				p2MatchScore+=6;
			} else if (playerOne == "James3927" && playerTwo == "Indefa") {
				p1SetScore+=1;
				p1MatchScore+=6;
				p2SetScore+=2;
				p2MatchScore+=8;
			} else if (playerOne == "Indefa" && playerTwo == "Blacktain Falcon") {
				p1SetScore+=2;
				p1MatchScore+=6;
				p2SetScore+=0;
				p2MatchScore+=1;
			} else if (playerOne == "Blacktain Falcon" && playerTwo == "Indefa") {
				p1SetScore+=0;
				p1MatchScore+=1;
				p2SetScore+=2;
				p2MatchScore+=6;
			}
			/** End Workaround << */

			updateContent('#p1SetScore', p1SetScore);
			updateContent('#p1MatchScore', p1MatchScore);
			updateContent('#p2SetScore', p2SetScore);
			updateContent('#p2MatchScore', p2MatchScore);

			let mostRecentSet = h2h.getMostRecentSet();
			if (typeof(mostRecentSet) !== "undefined"){
				updateContent("#recentSetScore", mostRecentSet.getScore(h2h.getP1id()) + " - " + mostRecentSet.getScore(h2h.getP2id()));
				updateContent("#recentSetDate", mostRecentSet.getDate().toDateString());
			} else {
				updateContent("#recentSetDate", "Haven't played this year");
			}
		} else {
			//TODO: Do something here? this means something went wrong (Very wrong).
		}
	} catch (err) {
		debug(err);
	}
}
	
//JSON file containing all current game information
var StreamJSON = '../z_Dependencies/settings.json';

async function readFromJson(){
	let f = await $.getJSON('../z_Dependencies/settings.json');
	
	let playerOne = f.Player_One;
	let playerTwo = f.Player_Two;
	return [playerOne, playerTwo]
}

var isUpdating = false;
var p1 = "";
var p2 = "";

async function checkForUpdates() {
	if (!isUpdating) {
		let players = await readFromJson();
		if (p1 != players[0] || p2 != players[1]) {
			isUpdating = true;
			clearContents();
			p1 = players[0];
			p2 = players[1];

			await run(p1, p2);

			isUpdating = false;
		}
	}
}

//Build the Displayed scene

//Start overlay layout update loop
setInterval (function() { checkForUpdates(); }, 1000);
</script>

</body>
</html>
